# Django + Stripe API
## Быстрый старт
- Используйте `.env` файл. Вы можете скопировать `.env.example`. В STRIPE_PUBLIC_KEY, STRIPE_SECRET_KEY и STRIPE_WEBHOOK_SECRET необходимо, соответственно, указать свою ключи.
    - STRIPE_PUBLIC_KEY, STRIPE_SECRET_KEY можно получить в личном кабинете официального сайта strype.com. 
    - STRIPE_WEBHOOK_SECRET получается с помощью команды `stripe listen --forward-to localhost:8000/webhooks/stripe/`, которую необходимо выполнить в отдельном терминале. Таким образом мы запускаем Stripe CLI, который должен работать на протяжении всей работы сервера.
- Запустите команду `docker compose up --build`
- Выполните миграции в отдельном терминале `docker exec my_api python ./my_api/manage.py migrate`
- Также необходимо отметить, что для тестирования непосредственно оплаты товаров необходимо создать их в базе данных. Один из способов добавления следующий: заходим в отдельном терминале в контейнер `my_api`(сервер должен быть запущен) с помощью команды `docker exec -it my_api /bin/sh`, далее выполняем команды `cd my_api`, затем `python manage.py createsuperuser` и создаем суперюзера, после чего выходим из контейнера с помощью комбинации клавиш `Ctrl + D`. Далее переходим на страницу `http://localhost:8000/admin/`, авторизируемся и добавляем товары.
### Последующие запуски выполняются следующим образом
- Запускаете команду `sudo docker compose up`
## Описание работы с магазином
Когда вы добавили товары, они отображаются на главной странице. Вы можете купить 1 единицу товара сразу, нажав на кнопку `Buy now`, далее заполнить необходимые поля оплаты (Карта: 4242 4242 4242 4242) и нажать кнопку `Pay now`, после чего вы можете вернуться обратно в магазин с помощью кнопки `Back to the shop`. Также вы можете добавлять товары в корзину и оплачивать корзину целиком. Для этого необходимо выбрать нужный товар, нажать на кнопку `Add to cart`, после чего указать необходимое количество товара и нажать кнопку `Add to the basket`. При обновлении страницы корзина обновится и появится кнопка `Place an order`. Вы можете удалить товары из корзины, нажав на крестик рядом с соответствующим товаром. Также вы можете и далее добавлять товары в корзину. После добавления всех товаров необходимо нажать кнопку `Place an order`, далее по аналогии заполнить форму оплаты и нажать кнопку `Pay now`. Далее вы снова можете вернуться в магазин и продолжить свои действия. Если комплексная оплата корзины прошла успешна и была перехвачена webhook'ом, то корзина должна очиститься (я думаю, что такое решение странное, но больше ничего в голову не пришло). Отправка email'ов webhook'ом является искусственной, итоговое сообщение можно увидеть в терминале сервера. Оно свидетельствует о том, что запрос прошел валидацию и успешно выполнен.
#### PS: Корзина обновляется на экране после обновления страницы. Также команды по запуску докера советую выполнять без флага `-d`, чтобы отслеживать в терминале поведение сервера, так будет удобнее.